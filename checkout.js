let countries = [  
  {
    "country": "Australia",
    "countryCode": "AUS",
    "regions": []
  },
  {
    "country": "Canada",
    "countryCode": "CA",
    "regions": [
      {
      "name": "Alberta",
      "code": "AB"
      },
      {
      "name": "British Columbia",
      "code": "BC"
      },
      {
      "name": "Manitoba",
      "code": "MB"
      },
      {
      "name": "New Brunswick",
      "code": "NB"
      },
      {
      "name": "Newfoundland and Labrador",
      "code": "NL"
      },
      {
      "name": "Northwest Territories",
      "code": "NT"
      },
      {
      "name": "Nova Scotia",
      "code": "NS"
      },
      {
      "name": "Nunavut",
      "code": "NU"
      },
      {
      "name": "Ontario",
      "code": "ON"
      },
      {
      "name": "Prince Edward Island",
      "code": "PE"
      },
      {
      "name": "Quebec",
      "code": "QC"
      },
      {
      "name": "Saskatchewan",
      "code": "SK"
      },
      {
      "name": "Yukon Territory",
      "code": "YT"
      }
      ]
  },
  {
    "country": "United States of America",
    "countryCode": "US",
    "regions": [
      {
      "name": "Alabama",
      "code": "AL"
      },
      {
      "name": "Alaska",
      "code": "AK"
      },
      {
      "name": "American Samoa",
      "code": "AS"
      },
      {
      "name": "Arizona",
      "code": "AZ"
      },
      {
      "name": "Arkansas",
      "code": "AR"
      },
      {
      "name": "California",
      "code": "CA"
      },
      {
      "name": "Colorado",
      "code": "CO"
      },
      {
      "name": "Connecticut",
      "code": "CT"
      },
      {
      "name": "Delaware",
      "code": "DE"
      },
      {
      "name": "District Of Columbia",
      "code": "DC"
      },
      {
      "name": "Federated States Of Micronesia",
      "code": "FM"
      },
      {
      "name": "Florida",
      "code": "FL"
      },
      {
      "name": "Georgia",
      "code": "GA"
      },
      {
      "name": "Guam",
      "code": "GU"
      },
      {
      "name": "Hawaii",
      "code": "HI"
      },
      {
      "name": "Idaho",
      "code": "ID"
      },
      {
      "name": "Illinois",
      "code": "IL"
      },
      {
      "name": "Indiana",
      "code": "IN"
      },
      {
      "name": "Iowa",
      "code": "IA"
      },
      {
      "name": "Kansas",
      "code": "KS"
      },
      {
      "name": "Kentucky",
      "code": "KY"
      },
      {
      "name": "Louisiana",
      "code": "LA"
      },
      {
      "name": "Maine",
      "code": "ME"
      },
      {
      "name": "Marshall Islands",
      "code": "MH"
      },
      {
      "name": "Maryland",
      "code": "MD"
      },
      {
      "name": "Massachusetts",
      "code": "MA"
      },
      {
      "name": "Michigan",
      "code": "MI"
      },
      {
      "name": "Minnesota",
      "code": "MN"
      },
      {
      "name": "Mississippi",
      "code": "MS"
      },
      {
      "name": "Missouri",
      "code": "MO"
      },
      {
      "name": "Montana",
      "code": "MT"
      },
      {
      "name": "Nebraska",
      "code": "NE"
      },
      {
      "name": "Nevada",
      "code": "NV"
      },
      {
      "name": "New Hampshire",
      "code": "NH"
      },
      {
      "name": "New Jersey",
      "code": "NJ"
      },
      {
      "name": "New Mexico",
      "code": "NM"
      },
      {
      "name": "New York",
      "code": "NY"
      },
      {
      "name": "North Carolina",
      "code": "NC"
      },
      {
      "name": "North Dakota",
      "code": "ND"
      },
      {
      "name": "Northern Mariana Islands",
      "code": "MP"
      },
      {
      "name": "Ohio",
      "code": "OH"
      },
      {
      "name": "Oklahoma",
      "code": "OK"
      },
      {
      "name": "Oregon",
      "code": "OR"
      },
      {
      "name": "Palau",
      "code": "PW"
      },
      {
      "name": "Pennsylvania",
      "code": "PA"
      },
      {
      "name": "Puerto Rico",
      "code": "PR"
      },
      {
      "name": "Rhode Island",
      "code": "RI"
      },
      {
      "name": "South Carolina",
      "code": "SC"
      },
      {
      "name": "South Dakota",
      "code": "SD"
      },
      {
      "name": "Tennessee",
      "code": "TN"
      },
      {
      "name": "Texas",
      "code": "TX"
      },
      {
      "name": "Utah",
      "code": "UT"
      },
      {
      "name": "Vermont",
      "code": "VT"
      },
      {
      "name": "Virgin Islands",
      "code": "VI"
      },
      {
      "name": "Virginia",
      "code": "VA"
      },
      {
      "name": "Washington",
      "code": "WA"
      },
      {
      "name": "West Virginia",
      "code": "WV"
      },
      {
      "name": "Wisconsin",
      "code": "WI"
      },
      {
      "name": "Wyoming",
      "code": "WY"
      }
    ]
  }

]
let addresses = [
  {"id": 1, 
  "EcomOrderCustomerName": "Customer1",
  "EcomOrderCustomerPhone": "555-555-5555",
  "EcomOrderCustomerEmail": "Customer1@test.com",
  "EcomOrderCustomerCompany": "Company1",
  "EcomOrderCustomerAddress": "Address1",
  "EcomOrderCustomerAddress2": "1",
  "EcomOrderCustomerCity": "Washington",  
  "EcomOrderCustomerCountry": "US",
  "EcomOrderCustomerRegion": "WA",
  "EcomOrderCustomerZip": "Zip1",
  },
  {"id": 2, 
  "EcomOrderCustomerName": "Customer2",
  "EcomOrderCustomerPhone": "555-555-5555",
  "EcomOrderCustomerEmail": "Customer2@test.com",
  "EcomOrderCustomerCompany": "Company2",
  "EcomOrderCustomerAddress": "Address2",
  "EcomOrderCustomerAddress2": "2",
  "EcomOrderCustomerCity": "Seattle",  
  "EcomOrderCustomerCountry": "US",
  "EcomOrderCustomerRegion": "WA",
  "EcomOrderCustomerZip": "Zip2",
  },
  {"id": 3, 
  "EcomOrderCustomerName": "Customer3",
  "EcomOrderCustomerPhone": "555-555-5555",
  "EcomOrderCustomerEmail": "Customer3@test.com",
  "EcomOrderCustomerCompany": "Company3",
  "EcomOrderCustomerAddress": "Address3",
  "EcomOrderCustomerAddress2": "3",
  "EcomOrderCustomerCity": "Los Angeles",  
  "EcomOrderCustomerCountry": "US",
  "EcomOrderCustomerRegion": "CA",
  "EcomOrderCustomerZip": "Zip3",
  },
  {"id": 4, 
  "EcomOrderCustomerName": "Customer4",
  "EcomOrderCustomerPhone": "555-555-5555",
  "EcomOrderCustomerEmail": "Customer4@test.com",
  "EcomOrderCustomerCompany": "Company4",
  "EcomOrderCustomerAddress": "Address4",
  "EcomOrderCustomerAddress2": "4",
  "EcomOrderCustomerCity": "Austin",
  "EcomOrderCustomerCountry": "US",
  "EcomOrderCustomerRegion": "TX",  
  "EcomOrderCustomerZip": "Zip4",
  }
]
const {createStore} = Redux;

const reducer = (state, {type,payload}) => { 
  if (type === "ChangeBillingCheckbox") {
    return payload ? {...state, "billingAddress": {...state.billingAddress, "selected": state.billingAddress.default}, billingIsShipping: payload} : {...state, "billingAddress": {...state.billingAddress, "selected": null}, billingIsShipping: payload}
  } 
  if (type === "ChangeDeliveryEditCheckbox") {    
    return payload ? {...state, "shippingAddress": {...state.shippingAddress, "selected": null}} : {...state, "shippingAddress": {...state.shippingAddress, "selected": state.shippingAddress.default}}
  } 
  if (type === "UpdateDeliveryAddress") {    
    return {...state, "shippingAddress": {"default": payload, "selected": payload}, "billingAddress": {"default": payload, "selected": state.billingAddress.selected !== null ? payload : null}}
  } 
  if (type === "UpdateOrderShippingAddress") {
    return {...state, "order": {...state.order, "shippingAddress": payload}}
  }
  if (type === "UpdateOrderBillingAddress") {
    return {...state, "order": {...state.order, "billingAddress": payload}}
  }
  return state;
}

const state = {
  "shippingAddress": {
    "default": 1,
    "selected": 1
  },
  "billingAddress": {
    "default": 1,
    "selected": 1
  },
  "addresses": addresses,
  "billingIsShipping": true,
  "countries": countries,
  "order" :{
    "shippingAddress": {},
    "billingAddress": {},
    "paymentId": null,
    "shippingId": null
  }
}

const store = createStore(reducer, state);
store.subscribe(() => {
  console.log("store changed to:  ", store.getState());
  renderAddressReadonly("Customer", store.getState().order.billingAddress);
  renderAddressReadonly("Delivery", store.getState().order.shippingAddress);
  fillAddress("Delivery");
  fillAddress("Customer");
});

//Functions
const getDataJSON = (country) => {  
  let dataJson = store.getState().countries;
  return new Promise((resolve,reject) => {
    if (country == undefined) {
      resolve(dataJson);
    } else {
      resolve(dataJson.filter(v => v.countryCode === country));
    }
    
  });
}
const featureCountry = (data,val) => {
  return [...data.filter(o => val.includes(o.countryCode)),...data.filter(o => !(val.includes(o.countryCode)))];  
}
const outputCountries = (data) => {
  return new Promise((resolve,reject) => { 
    let d = data.reduce((r,v,k) => {
      return r + '<option value='+v.countryCode+'>'+v.country+'</option>'
    },"");
    document.querySelectorAll("select.country").forEach(n => {
      n.innerHTML = d;
    })
    resolve(data);
  })
}
const outputRegions = (data, node = undefined) => {
  return new Promise((resolve,reject)=>{         
    if (node == undefined) {             
      document.querySelectorAll("select.region").forEach(n => {
        n.innerHTML = data[0].regions.reduce((r,v,k) => {
          return r + '<option value='+v.code+'>'+v.name+'</option>'
        },"");
      });
    } else {
      if(data[0].regions.length === 0) {        
        transformSelectIntoInput(node);
        registerEventAfterRender(document.getElementById(node.attributes.name.value));
      } else {        
        transformInputIntoSelect(node);        
        document.getElementById(node.attributes.id.value).innerHTML = data[0].regions.reduce((r,v,k) => {
          return r + '<option value='+v.code+'>'+v.name+'</option>'
        },"");  
        document.getElementById(node.attributes.id.value).value = data[0].regions[0].code;
        registerEventAfterRender(document.getElementById(node.attributes.name.value));
      }  
      
    }
    
    resolve(data[0]);
  });
}
const transformSelectIntoInput = (node) => {
  let input = document.createElement("input");
  input.type = "text";
  input.name = node.attributes.name.value;
  input.id = node.attributes.id.value; 
  node.after(input)
  node.remove(); 
}
const transformInputIntoSelect = (node) => {
  let select = document.createElement("select");
  select.name = node.attributes.name.value;
  select.id = node.attributes.id.value;
  select.classList.add("region");
  node.after(select);
  node.remove(); 
}
const getCountryText = (code) => {    
  return store.getState().countries.filter(o => o.countryCode === code)[0].country;
}
const initializeStep = () => {
  return new Promise((resolve, reject) => {
    let defaultAddress = store.getState().addresses.filter(o=>o.id === parseFloat(document.getElementById("AddressPicker").value))[0];  
    let {id, ...address} = defaultAddress;
    store.dispatch({type: "UpdateOrderShippingAddress", payload: address});
    if (store.getState().billingIsShipping) {
      store.dispatch({type: "UpdateOrderBillingAddress", payload: address});
    }    
    resolve(true);
  });  
}
const renderAddressReadonly = (target = "Customer", address = {}) => {  
  if (target === "Delivery" && Object.keys(address).length > 0) {
    document.getElementById("shipping-address-readonly").innerHTML = `<p>${address.EcomOrderCustomerAddress}<br>${address.EcomOrderCustomerCity}, ${address.EcomOrderCustomerRegion} ${address.EcomOrderCustomerZip}<br>${getCountryText(address.EcomOrderCustomerCountry)}<br>${address.EcomOrderCustomerEmail}<br>${address.EcomOrderCustomerPhone}</p>`;
    document.getElementById("summary-shipping").innerHTML = `<p>${address.EcomOrderCustomerAddress}<br>${address.EcomOrderCustomerCity}, ${address.EcomOrderCustomerRegion} ${address.EcomOrderCustomerZip}<br>${getCountryText(address.EcomOrderCustomerCountry)}<br>${address.EcomOrderCustomerEmail}<br>${address.EcomOrderCustomerPhone}</p>`;
    if (store.getState().billingIsShipping) {
      document.getElementById("summary-billing").innerHTML = `<p>${address.EcomOrderCustomerAddress}<br>${address.EcomOrderCustomerCity}, ${address.EcomOrderCustomerRegion} ${address.EcomOrderCustomerZip}<br>${getCountryText(address.EcomOrderCustomerCountry)}<br>${address.EcomOrderCustomerEmail}<br>${address.EcomOrderCustomerPhone}</p>`;
    }
  } else if (Object.keys(address).length > 0) {
    document.getElementById("summary-billing").innerHTML = `<p>${address.EcomOrderCustomerAddress}<br>${address.EcomOrderCustomerCity}, ${address.EcomOrderCustomerRegion} ${address.EcomOrderCustomerZip}<br>${getCountryText(address.EcomOrderCustomerCountry)}<br>${address.EcomOrderCustomerEmail}<br>${address.EcomOrderCustomerPhone}</p>`; 
  }  
}
const formatAddress = (node = undefined) => {
  let address = {};
  if (node == undefined) {
    throw new Error ("node was undefined, please input an ID")
    return {};
  } else { 
    document.getElementById(node).querySelectorAll('input[type="text"]').forEach((el) => {    
      let name = el.attributes.name.value.replace("Delivery","Customer");
      let value = el.value;
      address[name] = value;
    });
    document.getElementById(node).querySelectorAll('input[type="email"]').forEach((el) => {    
      let name = el.attributes.name.value.replace("Delivery","Customer");
      let value = el.value;
      address[name] = value;
    });
    document.getElementById(node).querySelectorAll('select').forEach((el) => {    
      let name = el.attributes.name.value.replace("Delivery","Customer");
      let value = el.value;
      address[name] = value;    
    });   
  }
  return address;
}
const fillAddress = (target = "Customer") => {
  if (target === "Delivery") { 
    let address = store.getState().order.shippingAddress;     
    for (let key in address) {
      if (address.hasOwnProperty(key)) { 
        if(key.includes("Region") === true) {            
          getDataJSON(address["EcomOrderCustomerCountry"])
            .then((data)=>{                  
              return outputRegions(data, document.getElementById("EcomOrderDeliveryRegion"))                  
            })
            .then((data)=>{ 
              document.getElementById(key.replace("Customer","Delivery")).value = address[key];
            }) 
        } else {             
          document.getElementById(key.replace("Customer","Delivery")).value = address[key];
        }
      }
    }
  } else {
    let address = store.getState().order.billingAddress;     
    for (let key in address) {
      if (address.hasOwnProperty(key)) { 
        if(key.includes("Region") === true) {            
          getDataJSON(address["EcomOrderCustomerCountry"])
            .then((data)=>{                  
              return outputRegions(data, document.getElementById("EcomOrderCustomerRegion"))                  
            })
            .then((data)=>{ 
              document.getElementById(key).value = address[key];
            }) 
        } else {             
          document.getElementById(key).value = address[key];
        }
      }
    }
  }
}

//Events
const registerEventAfterRender = (node) => {
  let name = node.attributes.name.value;
  if(name.includes("Customer")) {
    node.addEventListener('change', () => {
      let address = formatAddress("billing-address");
      store.dispatch({type: "UpdateOrderBillingAddress", payload: address});
    });   
    // console.log("cust",node.value);
  }
  if(name.includes("Delivery")) {     
    node.addEventListener('change', () => {
      let address = formatAddress("shipping-address");
      store.dispatch({type: "UpdateOrderShippingAddress", payload: address});
      if (store.getState().billingIsShipping) {
        store.dispatch({type: "UpdateOrderBillingAddress", payload: address});
      }  
    });
   
    // console.log("deliv",node.value);
  }

}
document.getElementById("editShippingAddress").querySelector("input").addEventListener('change',(e) => {  
  store.dispatch({type: "ChangeDeliveryEditCheckbox", payload: e.currentTarget.checked});  
  if (e.currentTarget.checked) {    
    document.getElementById("shipping-address").classList.remove("d-none");
    document.getElementById("shipping-address-readonly").classList.add("d-none");
    document.getElementById("AddressPicker").classList.add("d-none");    
  } else {
    document.getElementById("shipping-address").classList.add("d-none");
    document.getElementById("shipping-address-readonly").classList.remove("d-none");
    document.getElementById("AddressPicker").classList.remove("d-none");
    let address = store.getState().addresses.filter(o=>o.id === store.getState().shippingAddress.default)[0]; 
    let {id, ...curatedAddress} = address;     
    store.dispatch({type: "UpdateOrderShippingAddress", payload: curatedAddress});
    if (store.getState().billingIsShipping) {
      store.dispatch({type: "UpdateOrderBillingAddress", payload: curatedAddress});
    }    
  }
});
document.getElementById("billingIsSameAsShipping").querySelector("input").addEventListener('change',(e) => { 
  store.dispatch({type: "ChangeBillingCheckbox", payload: e.currentTarget.checked});
  if (e.currentTarget.checked) {
    document.getElementById("billing-address").classList.add("d-none"); 
    let address = store.getState().order.shippingAddress;
    store.dispatch({type: "UpdateOrderBillingAddress", payload: address});
  } else {    
    document.getElementById("billing-address").classList.remove("d-none");
  }
});
document.getElementById("AddressPicker").addEventListener('change',(e) => {  
  store.dispatch({type: "UpdateDeliveryAddress", payload: parseFloat(e.currentTarget.value)}); 
  let address = store.getState().addresses.filter(o=>o.id === parseFloat(e.currentTarget.value))[0];
  let {id, ...curatedAddress} = address;
  store.dispatch({type: "UpdateOrderShippingAddress", payload: curatedAddress});
  if (store.getState().billingIsShipping) {
    store.dispatch({type: "UpdateOrderBillingAddress", payload: curatedAddress});
  }
});
document.getElementById("EcomOrderDeliveryCountry").addEventListener('change', (e) => {
  getDataJSON(e.currentTarget.value)
    .then((data)=>{return outputRegions(data, document.getElementById("EcomOrderDeliveryRegion"))})
    .then((data) => {
      let address = formatAddress("shipping-address");
      store.dispatch({type: "UpdateOrderShippingAddress", payload: address});
      if (store.getState().billingIsShipping) {
        store.dispatch({type: "UpdateOrderBillingAddress", payload: address});
      }  
    })       
});
document.getElementById("EcomOrderCustomerCountry").addEventListener('change', (e) => {
  getDataJSON(e.currentTarget.value)
    .then((data)=>{return outputRegions(data, document.getElementById("EcomOrderCustomerRegion"))})
    .then((data) => {
      let address = formatAddress("billing-address");
      store.dispatch({type: "UpdateOrderBillingAddress", payload: address});
    })   
});
document.getElementById("shipping-address").querySelectorAll("input").forEach((el) => {
  el.addEventListener("change", (e) => {
    let address = formatAddress("shipping-address");    
    store.dispatch({type: "UpdateOrderShippingAddress", payload: address});
    if (store.getState().billingIsShipping) {
      store.dispatch({type: "UpdateOrderBillingAddress", payload: address});
    }    
  });
});
document.getElementById("shipping-address").querySelectorAll("select").forEach((el) => {
  el.addEventListener("change", (e) => {
    let name = e.currentTarget.attributes.name.value;
    if (name.includes("Country")) {
      return;
    }
    let address = formatAddress("shipping-address");
    
    store.dispatch({type: "UpdateOrderShippingAddress", payload: address});
    if (store.getState().billingIsShipping) {
      store.dispatch({type: "UpdateOrderBillingAddress", payload: address});
    }  
  });
})
document.getElementById("billing-address").querySelectorAll("input").forEach((el) => {
  el.addEventListener("change", (e) => {
    let address = formatAddress("billing-address");
    store.dispatch({type: "UpdateOrderBillingAddress", payload: address});
  });
});
document.getElementById("billing-address").querySelectorAll("select").forEach((el) => {
  el.addEventListener("change", (e) => {
    let address = formatAddress("billing-address");
    store.dispatch({type: "UpdateOrderBillingAddress", payload: address});
  });
})

document.getElementById("step1").addEventListener("submit", (e) => {
  if (document.getElementById("saveAddress").querySelector("input").checked) {
    alert (JSON.stringify(store.getState().order.shippingAddress));   
  }
  e.preventDefault();

});

//Init
getDataJSON()
  .then((data) => {return featureCountry(data,"CA")})
  .then((data) => {return featureCountry(data,"US")})
  .then((data) => {return outputCountries(data)}) 
  .then((data) => {return outputRegions(data)})
  .then((data) => {return initializeStep()})



